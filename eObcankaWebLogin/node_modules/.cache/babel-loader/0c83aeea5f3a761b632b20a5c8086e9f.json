{"ast":null,"code":"import _classCallCheck from \"/home/roman/testws/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/home/roman/testws/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport * as ecCrypto from 'eccrypto';\nvar webSocketUrl = 'ws://192.168.51.154:8080/websocket/msg'; // automatical request\n\nvar responseObject = {\n  cmd: 'handshake',\n  msg: {\n    birthNumber: '120493904239048',\n    documentNumber: '271498327498',\n    publicKey: '23oiroi2joi23jrio23j'\n  },\n  signature: '99r8329r8j2398fj93f2j983f2j'\n};\n\nvar WebID =\n/*#__PURE__*/\nfunction () {\n  function WebID() {\n    _classCallCheck(this, WebID);\n\n    this.webSocket = new WebSocket(webSocketUrl);\n    this.setListeners();\n    this.handshakeData = null;\n    this.message = null;\n    this.signature = null;\n    this.handshakeCallback = null;\n  }\n\n  _createClass(WebID, [{\n    key: \"login\",\n    value: function login(cb) {\n      if (this.webSocket.readyState === 1) {\n        console.log('try to login');\n        this.handshakeCmd = true;\n        this.webSocket.send(JSON.stringify({\n          cmd: 'handshake',\n          msg: {}\n        }));\n        this.handshakeCallback = cb;\n      } else {\n        console.log('connection error');\n        cb({\n          msg: 'connection error',\n          readyState: this.webSocket.readyState\n        }, null, null);\n      }\n    }\n  }, {\n    key: \"handshake\",\n    value: function handshake(message, signature) {\n      var _this = this;\n\n      this.validateHandshake(message, signature).then(function () {\n        return _this.handshakeCallback && _this.handshakeCallback(null, message, signature);\n      }).catch(function (err) {\n        return _this.handshakeCallback && _this.handshakeCallback(err, null, null);\n      });\n    }\n  }, {\n    key: \"listenToStatusChange\",\n    value: function listenToStatusChange(cb) {\n      var _this2 = this;\n\n      this.webSocket.onmessage = function (event) {\n        var data = _this2.parseEventData(event);\n\n        if (data.cmd === 'card-present-status') {\n          cb(data.msg);\n        }\n      };\n    }\n  }, {\n    key: \"setListeners\",\n    value: function setListeners() {\n      var _this3 = this;\n\n      this.webSocket.onmessage = function (event) {\n        var data = _this3.parseEventData(event);\n\n        switch (data.cmd) {\n          case 'handshake':\n            _this3.handshake(data.msg, data.signature);\n\n            break;\n\n          case 'data':\n            _this3.getData(data.msg, data.signature);\n\n            break;\n\n          case 'card-present-status':\n            // implemented in other listener\n            break;\n\n          default:\n            console.log('unknown cmd');\n        }\n      };\n    }\n  }, {\n    key: \"parseEventData\",\n    value: function parseEventData(event) {\n      var data = JSON.parse(event.data);\n      console.log(data);\n      return data;\n    }\n  }, {\n    key: \"validateHandshake\",\n    value: function validateHandshake(message, signature) {\n      return new Promise(function (resolve, reject) {\n        var publicKey = message.publicKey;\n        var signedMessage = JSON.stringify(message);\n        var bufferedMessage = Buffer.from(signedMessage, 'utf8');\n        ecCrypto.verify(publicKey, bufferedMessage, signature).then(function () {\n          return resolve(true);\n        }).catch(function () {\n          return reject(false);\n        });\n      });\n    }\n  }]);\n\n  return WebID;\n}();\n\nexport default WebID;","map":{"version":3,"sources":["/home/roman/testws/src/components/webId.js"],"names":["ecCrypto","webSocketUrl","responseObject","cmd","msg","birthNumber","documentNumber","publicKey","signature","WebID","webSocket","WebSocket","setListeners","handshakeData","message","handshakeCallback","cb","readyState","console","log","handshakeCmd","send","JSON","stringify","validateHandshake","then","catch","err","onmessage","event","data","parseEventData","handshake","getData","parse","Promise","resolve","reject","signedMessage","bufferedMessage","Buffer","from","verify"],"mappings":"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","sourcesContent":["import * as ecCrypto from 'eccrypto';\nconst webSocketUrl = 'ws://192.168.51.154:8080/websocket/msg';\n\n// automatical request\nconst responseObject = {\n  cmd: 'handshake',\n  msg: {\n    birthNumber: '120493904239048',\n    documentNumber: '271498327498',\n    publicKey: '23oiroi2joi23jrio23j'\n  },\n  signature: '99r8329r8j2398fj93f2j983f2j'\n}\n\nclass WebID {\n\n  constructor() {\n    this.webSocket = new WebSocket(webSocketUrl);\n    this.setListeners();\n    this.handshakeData = null;\n    this.message = null;\n    this.signature = null;\n    this.handshakeCallback = null;\n  }\n\n  login(cb) {\n    if (this.webSocket.readyState === 1) {\n      console.log('try to login');\n      this.handshakeCmd = true;\n      this.webSocket.send(JSON.stringify({ cmd: 'handshake', msg: {} }));\n      this.handshakeCallback = cb;\n    } else {\n      console.log('connection error');\n      cb({ msg: 'connection error', readyState: this.webSocket.readyState }, null, null);\n    }\n  }\n\n  handshake(message, signature) {\n    this.validateHandshake(message, signature)\n        .then(() => this.handshakeCallback && this.handshakeCallback(null, message, signature))\n        .catch((err) => this.handshakeCallback && this.handshakeCallback(err, null, null));\n  }\n\n  listenToStatusChange(cb){\n    this.webSocket.onmessage = (event) => {\n      const data = this.parseEventData(event);\n      if(data.cmd === 'card-present-status') {\n        cb(data.msg);\n      }\n    }\n  }\n\n  setListeners() {\n    this.webSocket.onmessage = (event) => {\n      const data = this.parseEventData(event);\n      switch (data.cmd) {\n        case 'handshake':\n          this.handshake(data.msg, data.signature);\n          break;\n        case 'data':\n          this.getData(data.msg, data.signature);\n          break;\n        case 'card-present-status':\n          // implemented in other listener\n          break;\n        default:\n          console.log('unknown cmd');\n      }\n    }\n  }\n\n  parseEventData(event) {\n    const data = JSON.parse(event.data);\n    console.log(data);\n    return data;\n  }\n\n  validateHandshake(message, signature) {\n    return new Promise((resolve, reject) => {\n      const publicKey = message.publicKey;\n      const signedMessage = JSON.stringify(message);\n      const bufferedMessage = Buffer.from(signedMessage, 'utf8');\n      ecCrypto.verify(publicKey, bufferedMessage, signature)\n        .then(() => resolve(true) )\n        .catch(() => reject(false) );\n    });\n  }\n\n}\n\nexport default WebID;"]},"metadata":{},"sourceType":"module"}